var anthesiteObj = new anthesite();

var booksApp = angular.module('booksApp', ['ngRoute']);

booksApp.controller('HomeController', function($scope, $routeParams) {
	// TODO
	
	selectMenu('#li-home');
});

booksApp.controller('RechercherController', function($scope, $http) {
	$scope.recherche = { 
			isbn : "", 
			libre: "",
			auteur: "",
			titre: ""
	};
	
	$scope.recherche_result = null;
	$scope.recherche_error = false;
	$scope.isbn_pattern = "^(97(8|9))?\\d{9}(\\d|X)$";
	
	$scope.add = function(id) {
		
	};
	
	$scope.rechercher = function() {
		$('#ajax-loader').show();
		
		var url = "https://www.googleapis.com/books/v1/volumes?q=";
		var hasSearchTerm = false;

		if ($scope.recherche.libre.length) {
			url += $scope.recherche.libre;
			hasSearchTerm = true;
		}
		
		if ($scope.recherche.isbn.length) {
			url += (hasSearchTerm ? "+" : "") + "isbn:" + $scope.recherche.isbn;
			hasSearchTerm = true;
		}
		
		if ($scope.recherche.auteur.length) {
			url += (hasSearchTerm ? "+" : "") + "inauthor:" + $scope.recherche.auteur;
			hasSearchTerm = true;
		}
		
		if ($scope.recherche.titre.length) {
			url += (hasSearchTerm ? "+" : "") + "intitle:" + $scope.recherche.titre;
			hasSearchTerm = true;
		}
		
	    $http.get(url).success(function(data, status) {
	    	$scope.recherche_error = false;
	    	$scope.recherche_result = data;
	    	$('#ajax-loader').hide();
	    }).error(function(data, status) {
	    	$scope.recherche_error = true;
	    });
	};
	
	selectMenu('#li-rechercher');
});

booksApp.controller('ExplorerController', function($scope, $routeParams) {
	$scope.message = "Hello ExplorerController !";
	
	selectMenu('#li-explorer');
});

// ***** Livres ***** \\
booksApp.controller('LivresListController', function($scope, $http, $location) {
	$scope.livres = {};
	$scope.error = {};

	$scope.del = function(id) {
		$location.path('/livres/' + id + '/delete');
	};
	
	$scope.edit = function(id) {
		$location.path('/livres/' + id + '/edit');
	};
	
	$http.get("rest/livres").success(function(data) {
		$scope.error = {};
    	$scope.livres = data;
    }).error(function(data) {
    	$scope.error = data;
    	$scope.livres = {};
    });
	
	selectMenu('#li-livres');
});

booksApp.controller('LivresFormController', function($scope, $http, $location) {
	// TODO
	$scope.sagas = [];
	$scope.auteurs = [];
	$scope.livre = {};
	
	$http.get("rest/sagas?order=nom").success(function(data) {
    	$scope.sagas = data;
    }).error(function(data) {
    	anthesiteObj.showAndHideAfter('app-error', 3000, 'fade');
    });
	
	$http.get("rest/auteurs?order=nom,prenom").success(function(data) {
    	$scope.auteurs = data;
    }).error(function(data) {
    	anthesiteObj.showAndHideAfter('app-error', 3000, 'fade');
    });
	
	selectMenu('#li-livres');
});

// ***** Auteurs ***** \\
booksApp.controller('AuteursListController', function($scope, $http, $location) {
	$scope.auteurs = {};
	$scope.error = {};

	$scope.del = function(id) {
		$location.path('/auteurs/' + id + '/delete');
	};
	
	$scope.edit = function(id) {
		$location.path('/auteurs/' + id + '/edit');
	};
	
	$http.get("rest/auteurs").success(function(data) {
		$scope.error = {};
    	$scope.auteurs = data;
    }).error(function(data) {
    	$scope.error = data;
    	$scope.auteurs = {};
    });
	
	selectMenu('#li-auteurs');
});

booksApp.controller('AuteursFormController', function($scope, $http, $routeParams, $location) {
	$scope.auteur = {};
	
	if ($routeParams.id) {
		$http.get('rest/auteurs/' + $routeParams.id).success(function(data, status) {
	    	$scope.auteur = data;
	    }).error(function(data, status) {
	    	anthesiteObj.showAndHideAfter('app-error', 3000, 'fade');
	    });
	}
	
	$scope.validate = function() {
		if ($routeParams.id) {
			$http.put('rest/auteurs/' + $routeParams.id, $scope.auteur).success(function() {
				$location.path('/auteurs');
				anthesiteObj.showAndHideAfter('app-confirm', 3000, 'fade');
		    }).error(function(data, status) {
		    	anthesiteObj.showAndHideAfter('app-error', 3000, 'fade');
		    });
		} else {
			$http.post('rest/auteurs', $scope.auteur).success(function() {
				$location.path('/auteurs');
				anthesiteObj.showAndHideAfter('app-confirm', 3000, 'fade');
		    }).error(function(data, status) {
		    	anthesiteObj.showAndHideAfter('app-error', 3000, 'fade');
		    });
		}
	}
	
	selectMenu('#li-auteurs');
});

booksApp.controller('AuteursDeleteController', function($scope, $http, $routeParams, $location) {
	$scope.del = function() {
		$http.delete('rest/auteurs/' + $routeParams.id).success(function() {
			$location.path('/auteurs');
			anthesiteObj.showAndHideAfter('app-confirm', 3000, 'fade');
		}).error(function() {
			anthesiteObj.showAndHideAfter('app-error', 3000, 'fade');
		});
	}
	
	selectMenu('#li-auteurs');
});

// ****** Sagas ***** \\
booksApp.controller('SagasListController', function($scope, $http, $location) {
	$scope.sagas = {};
	$scope.error = {};

	$scope.del = function(id) {
		$location.path('/sagas/' + id + '/delete');
	};
	
	$scope.edit = function(id) {
		$location.path('/sagas/' + id + '/edit');
	};
	
	$http.get("rest/sagas").success(function(data) {
		$scope.error = {};
    	$scope.sagas = data;
    }).error(function(data) {
    	$scope.error = data;
    	$scope.sagas = {};
    });
	
	selectMenu('#li-sagas');
});

booksApp.controller('SagasFormController', function($scope, $http, $routeParams, $location) {
	$scope.saga = {};
	
	if ($routeParams.id) {
		$http.get('rest/sagas/' + $routeParams.id).success(function(data, status) {
	    	$scope.saga = data;
	    }).error(function(data, status) {
	    	anthesiteObj.showAndHideAfter('app-error', 3000, 'fade');
	    });
	}
	
	$scope.validate = function() {
		if ($routeParams.id) {
			$http.put('rest/sagas/' + $routeParams.id, $scope.saga).success(function() {
				$location.path('/sagas');
				anthesiteObj.showAndHideAfter('app-confirm', 3000, 'fade');
		    }).error(function(data, status) {
		    	anthesiteObj.showAndHideAfter('app-error', 3000, 'fade');
		    });
		} else {
			$http.post('rest/sagas', $scope.saga).success(function() {
				$location.path('/sagas');
				anthesiteObj.showAndHideAfter('app-confirm', 3000, 'fade');
		    }).error(function(data, status) {
		    	anthesiteObj.showAndHideAfter('app-error', 3000, 'fade');
		    });
		}
	}
	
	selectMenu('#li-sagas');
});

booksApp.controller('SagasDeleteController', function($scope, $http, $routeParams, $location) {
	$scope.del = function() {
		$http.delete('rest/sagas/' + $routeParams.id).success(function() {
			$location.path('/sagas');
			anthesiteObj.showAndHideAfter('app-confirm', 3000, 'fade');
		}).error(function() {
			anthesiteObj.showAndHideAfter('app-error', 3000, 'fade');
		});
	}
	
	selectMenu('#li-sagas');
});

// ***** Routing ***** \\
booksApp.config([ '$routeProvider', function($routeProvider) {
	$routeProvider.when('/', {
		templateUrl : 'partials/home-partial.html',
		controller : 'HomeController'
	}).when('/rechercher', {
		templateUrl : 'partials/rechercher-partial.html',
		controller : 'RechercherController'
	}).when('/explorer', {
		templateUrl : 'partials/explorer-partial.html',
		controller : 'ExplorerController'
	}).when('/livres', {
		templateUrl : 'partials/livres/livres-list.html',
		controller : 'LivresListController'
	}).when('/livres/add', {
		templateUrl : 'partials/livres/livres-form.html',
		controller : 'LivresFormController'
	}).when('/livres/add/:id', {
		templateUrl : 'partials/livres/livres-form.html',
		controller : 'LivresFormController'
	}).when('/livres/:id/edit', {
		templateUrl : 'partials/livres/livres-form.html',
		controller : 'LivresFormController'
	}).when('/livres/:id/delete', {
		templateUrl : 'partials/livres/livres-delete.html',
		controller : 'LivresDeleteController'
	}).when('/auteurs', {
		templateUrl : 'partials/auteurs/auteurs-list.html',
		controller : 'AuteursListController'
	}).when('/auteurs/:id/delete', {
		templateUrl : 'partials/auteurs/auteurs-delete.html',
		controller : 'AuteursDeleteController'
	}).when('/auteurs/:id/edit', {
		templateUrl : 'partials/auteurs/auteurs-form.html',
		controller : 'AuteursFormController'
	}).when('/auteurs/add', {
		templateUrl : 'partials/auteurs/auteurs-form.html',
		controller : 'AuteursFormController'
	}).when('/sagas', {
		templateUrl : 'partials/sagas/sagas-list.html',
		controller : 'SagasListController'
	}).when('/sagas/:id/delete', {
		templateUrl : 'partials/sagas/sagas-delete.html',
		controller : 'SagasDeleteController'
	}).when('/sagas/:id/edit', {
		templateUrl : 'partials/sagas/sagas-form.html',
		controller : 'SagasFormController'
	}).when('/sagas/add', {
		templateUrl : 'partials/sagas/sagas-form.html',
		controller : 'SagasFormController'
	}).otherwise({
		redirectTo : '/'
	});
} ]);

var selectMenu = function(menuId) {
	$("#ul-menu li").removeClass("active");
	$(menuId).addClass("active");
};