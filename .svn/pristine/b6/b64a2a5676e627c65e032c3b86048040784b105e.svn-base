package info.san.biblio.app.model.listener;

import info.san.biblio.app.Persistence;
import info.san.biblio.app.event.serie.SaisonCreatedEvent;
import info.san.biblio.app.event.serie.SaisonDeletedEvent;
import info.san.biblio.app.model.entry.SaisonEntry;
import info.san.biblio.app.model.entry.SerieEntry;

import javax.persistence.EntityManager;
import javax.persistence.EntityTransaction;

import org.axonframework.eventhandling.annotation.EventHandler;

public class SaisonListener {

	private EntityManager em = Persistence.getInstance().createEntityManager();

	@EventHandler
	public void handle(SaisonCreatedEvent e) {
		EntityTransaction t = this.em.getTransaction();

		t.begin();

		SerieEntry serie = this.em.find(SerieEntry.class, e.getSerieId());

		SaisonEntry saison = new SaisonEntry();
		saison.setId(e.getId());
		saison.setIdx(e.getIdx());
		saison.setName(e.getName());
		saison.setSerie(serie);

		this.em.persist(saison);

		t.commit();
	}

	@EventHandler
	public void handle(SaisonDeletedEvent e) {
		EntityTransaction t = this.em.getTransaction();

		t.begin();

		this.em.remove(this.em.find(SaisonEntry.class, e.getId()));

		t.commit();
	}

}
